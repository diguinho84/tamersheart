<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="style.css"/>
</head>

<script>

    //variaveis
    var canvasHeight;
    var canvasWidth;
    var ctx;

    var coordX = 0;
    var coordY = 0;
    var moveDireita = 0;
    var moveEsquerda = 0;
    var moveCima = 0;
    var moveBaixo = 0;
    var player = 0;
    var alturaDefault = 0;
    var alturaGroundCenario = 0;
    
    var distPadrao = 1;
    var avancoPadrao = 3;
    var gravidadePadrao = 1;

    var teclaPressionada;
    var teclaLiberada;

    var elementosMapa = [];
    var gravitaveis = [];
    var grounds = [];

    var npc1;
    var comandosDiretosNPC = ["dir", "dir"];

    //classes
    class Quadrado {

      constructor(x, y, width, height){
        this.x = x;
        this.y = y;
        this.width = width;
        this.height = height;
      }

      getXm(){ return this.x + (width/2) }
      getYm(){ return this.x + (width/2) }
      getPontoMedio(){ return {xm: getXm(), ym: getYm()} }
    
    }

    class Circulo{

      constructor(x, y, raio){
        this.x = x;
        this.y = y;
        this.raio = raio;
      }

      getCenter(){ return {x: this.x, y: this.y} }
      getRaio(){ return this.raio; }
    }

    
    class Player{

      constructor(obj){
        this.idObj = obj.idObj !== undefined ? obj.idObj : 0; 
        this.x = obj.x;
        this.y = obj.y;
        this.width = obj.width;
        this.height = obj.height;
        this.bounced = [];
        this.groundable = 1;
        this.orientavel = obj.orientavel !== undefined ? obj.orientavel : 0;
        this.gravitavel = obj.gravitavel !== undefined ? obj.gravitavel : 0;
        this.empurravel = obj.empurravel !== undefined ? obj.empurravel : 0;
        this.respostaAcoesPedidas = [];
        this.pilhaDeComandos = {
          "direcoes"  : [],    
          "sequencia" : []
        };
        // {
        //     "pulo" : acaoPular
        // };
      }
      
      getXm(){ return this.x + (this.width/2) }
      getYm(){ return this.x + (this.width/2) }
      getPontoMedio(){ return {xm: this.getXm(), ym: this.getYm()} }
      getRaio(){ return this.width/2 }
      getCirculo(){ return new Circulo(this.x, this.y, this.getRaio())}
      
    }

    var previous = {};
    
    function knockback(player){

      var hitbox = player.weapon !== undefined ? player.weapon : new Player({x: 50, y:alturaDefault -10, width:10, height:10, idObj: "elemento0"});
 
    }

    function pular(player){
      
      if(isOnGround(player, elementosMapa.filter(obj => obj.groundable == 1 && obj.idObj != player.idObj)) && (player.pulo === undefined) ){
        player.pulo = new Pulo({size: 4, cima: 15, baixo: 0});
      }

      if(player.pulo !== undefined){
        player.pulo.performa(player);
      }
    }

    class Pulo{
      
      constructor(obj){
        this.size = obj.size;
        this.cima = obj.cima;
        this.baixo = obj.baixo;
      }

      performa(player){


        if(this.cima > 0){
          if( (tryMove(player, "y", -1, this.size))){
            this.cima--
          }else{
            this.cima = 0;
          }
        }else{
          player.nroPulos = player.nroPulos !== undefined ? player.nroPulos + 1 : 1;  
          delete player.pulo;
          delete player.respostaAcoesPedidas["pular"];
        }
      }

    }

    function impulse(player){
      
      // if(isOnGround(player, elementosMapa.filter(obj => obj.groundable == 1 && obj.idObj != player.idObj)) ){
      //   player.pulo = new Pulo({size: 4, cima: 15, baixo: 0});
      // }
      if(player.impulse === undefined ){
          player.impulse = new Impulse({"intensidade": 5, "direcao": "dir", "iteracoes": 5});
      } 

      if(player.impulse !== undefined){
        player.impulse.performa(player);
      }
    }

    class Impulse{
      
      constructor(obj){
        this.intensidade = obj.intensidade;
        this.direcao = obj.direcao;
        this.iteracoes = obj.iteracoes;
        if(obj.direcao == "dir")  { this.eixo = "x"; this.sentido =   1 }
        if(obj.direcao == "esq")  { this.eixo = "x"; this.sentido =  -1 }
        if(obj.direcao == "cima") { this.eixo = "y"; this.sentido =  -1 }
        if(obj.direcao == "baixo"){ this.eixo = "y"; this.sentido =   1 }    
      }

      performa(player){


        if(this.iteracoes > 0){
          if( (tryMove(player, this.eixo, this.sentido, this.iteracoes))){
            this.iteracoes--;
          }else{
            this.iteracoes = 0;
          }
        }else{
          //player.nroPulos = player.nroPulos !== undefined ? player.nroPulos + 1 : 1;  
          delete player.impulse;
          delete player.respostaAcoesPedidas["impulse"];
        }
      }

    }

    class Bounce{

      constructor(obj){
        this.intensidade = obj.intensidade;
        this.iteracoes = obj.iteracoes;
        this.directions = obj.directions !== undefined ? obj.directions : [];
      }
    }

    class Bounced{

      constructor(obj){
        this.intensidade = obj.intensidade;
        this.direction = obj.direction;
        this.axis = obj.axis;
        this.iteracoes = obj.iteracoes;
      }
    }

    
    
//#region Init Settings
function initCanvasContextSettings(){

    canvasHeight = Number.parseInt(document.getElementById("canvas").getAttribute("height"));
    canvasWidth = Number.parseInt(document.getElementById("canvas").getAttribute("width"));
    ctx = document.getElementById("canvas").getContext("2d");
}

function init(){

  //varaives padrao canvas
  initCanvasContextSettings();

  alturaGroundCenario = 20; 
  alturaDefault = canvasHeight - alturaGroundCenario;

  //inicializa o player, talvez os demais elementos e players
  player = new Player({x: 10, y:alturaDefault -15, width:10, height:10, gravitavel: 1, orientavel: 1,  idObj: "player"});

  elementosMapa.push(player);
  elementosMapa.push(new Player({x: 50, y:alturaDefault -10, width:10, height:10, idObj: "elemento0"}))
  elementosMapa.push(new Player({x: 70, y:alturaDefault -10, width:10, height:10, idObj: "elemento1"}))
  elementosMapa.push(new Player({x: 90, y:alturaDefault -20, width:10, height:10, idObj: "elemento2"}))
  elementosMapa.push(new Player({x: 120, y:alturaDefault -10, width:10, height:10, gravitavel: 1, empurravel: 1, idObj: "elemento3"}))
  elementosMapa.push(new Player({x: 0, y:canvasHeight - alturaGroundCenario + 0.01, width:canvasWidth, height:canvasHeight/4, idObj: "ground"}))

  elementosMapa[1].bounce = new Bounce({intensidade: 1.5, iteracoes: 40, directions: ["left", "up", "leftup"]});
  elementosMapa[4].bounce = new Bounce({intensidade: 1.5, iteracoes: 40, directions: ["left", "up", "leftup"]});
  
  npc1 = elementosMapa[4];

  //starta o loop de animacao
  window.requestAnimationFrame(draw);
}
//#endregion




//#region Movimentacao logica
//sao dois sinais apenas por enquanto, down e up
function setaVetoresDirecao(player, e){

  //Seta os vetores direcao
  //Como sÃ³ tem keydown ou keyup deu pra fazer o ternario
  if( e.key == "ArrowRight")         {  
    if((e.type == "keydown") && (player.pilhaDeComandos["direcoes"]["dir"] !== 1 ) ){
      player.pilhaDeComandos["direcoes"]["dir"] = 1;
      player.pilhaDeComandos["sequencia"].push("dir");
    }
    if((e.type == "keyup") && (player.pilhaDeComandos["direcoes"]["dir"] !== 0 ) ){
      player.pilhaDeComandos["direcoes"]["dir"] = 0;
    }
  }

  if( e.key == "ArrowLeft")         {  
    if((e.type == "keydown") && (player.pilhaDeComandos["direcoes"]["esq"] !== 1 ) ){
      player.pilhaDeComandos["direcoes"]["esq"] = 1;
      player.pilhaDeComandos["sequencia"].push("esq");
    }
    if((e.type == "keyup") && (player.pilhaDeComandos["direcoes"]["esq"] !== 0 ) ){
      player.pilhaDeComandos["direcoes"]["esq"] = 0;
    }
  }

  if( e.key == "ArrowUp")         {  
    if((e.type == "keydown") && (player.pilhaDeComandos["direcoes"]["cima"] !== 1 ) ){
      player.pilhaDeComandos["direcoes"]["cima"] = 1;
      player.pilhaDeComandos["sequencia"].push("cima");
    }
    if((e.type == "keyup") && (player.pilhaDeComandos["direcoes"]["cima"] !== 0 ) ){
      player.pilhaDeComandos["direcoes"]["cima"] = 0;
    }
  }

  if( e.key == "ArrowDown")         {  
    if((e.type == "keydown") && (player.pilhaDeComandos["direcoes"]["baixo"] !== 1 ) ){
      player.pilhaDeComandos["direcoes"]["baixo"] = 1;
      player.pilhaDeComandos["sequencia"].push("baixo");
    }
    if((e.type == "keyup") && (player.pilhaDeComandos["direcoes"]["baixo"] !== 0 ) ){
      player.pilhaDeComandos["direcoes"]["baixo"] = 0;
    }
  }

  if( e.key == "a" || e.key == "A")         {  
    if((e.type == "keydown") && (player.pilhaDeComandos["direcoes"]["a"] !== 1 ) ){
      player.pilhaDeComandos["direcoes"]["a"] = 1;
      player.pilhaDeComandos["sequencia"].push("a");
    }
    if((e.type == "keyup") && (player.pilhaDeComandos["direcoes"]["a"] !== 0 ) ){
      player.pilhaDeComandos["direcoes"]["a"] = 0;
    }
  }

}

function gerenciadorComandos(player){

  console.log(player.pilhaDeComandos)
  var ultimo;
  var penultimo;
  var sequencia = player.pilhaDeComandos.sequencia;
  if( (sequencia) && sequencia.length >= 2){
    ultimo = sequencia[sequencia.length - 1];
    penultimo = sequencia[sequencia.length - 2];
  }
  for(var key in player.pilhaDeComandos["direcoes"]){
    
    if(key == "dir" && (player.pilhaDeComandos["direcoes"]["dir"] == 1 ) ){
      if(ultimo == "dir" && (penultimo == "dir") ){
        player.respostaAcoesPedidas["tryMoveDir"] = player.respostaAcoesPedidas["tryMoveDir"] === undefined ? tryAvancoDir : player.respostaAcoesPedidas["tryMoveDir"];
      }else{
        player.respostaAcoesPedidas["tryMoveDir"] = player.respostaAcoesPedidas["tryMoveDir"] === undefined ? tryMoveDir : player.respostaAcoesPedidas["tryMoveDir"];
      }      
    }
    if(key == "dir" && (player.pilhaDeComandos["direcoes"]["dir"] == 0 ) ){
      player.respostaAcoesPedidas["tryMoveDir"] !== undefined ? delete player.respostaAcoesPedidas["tryMoveDir"] : 0;      
    }

    if(key == "esq" && (player.pilhaDeComandos["direcoes"]["esq"] == 1 ) ){
      if( ultimo == "esq" && (penultimo == "esq") ){
        player.respostaAcoesPedidas["tryMoveEsq"] = player.respostaAcoesPedidas["tryMoveEsq"] === undefined ? tryAvancoEsq : player.respostaAcoesPedidas["tryMoveEsq"];  
      }else{
        player.respostaAcoesPedidas["tryMoveEsq"] = player.respostaAcoesPedidas["tryMoveEsq"] === undefined ? tryMoveEsq : player.respostaAcoesPedidas["tryMoveEsq"];
      }
    }
    if(key == "esq" && (player.pilhaDeComandos["direcoes"]["esq"] == 0 ) ){
      player.respostaAcoesPedidas["tryMoveEsq"] !== undefined ? delete player.respostaAcoesPedidas["tryMoveEsq"] : 0;      
    }

    if(key == "baixo" && (player.pilhaDeComandos["direcoes"]["baixo"] == 1 ) ){
      player.respostaAcoesPedidas["tryMoveBaixo"] = player.respostaAcoesPedidas["tryMoveBaixo"] === undefined ? tryMoveBaixo : player.respostaAcoesPedidas["tryMoveBaixo"];      
    }
    if(key == "baixo" && (player.pilhaDeComandos["direcoes"]["baixo"] == 0 ) ){
      player.respostaAcoesPedidas["tryMoveBaixo"] !== undefined ? delete player.respostaAcoesPedidas["tryMoveBaixo"] : 0;      
    }

    if(key == "cima" && (player.pilhaDeComandos["direcoes"]["cima"] == 1 ) ){
      if( isOnGround(player, elementosMapa.filter(obj => obj.groundable == 1 && obj.idObj != player.idObj))  ){
        player.respostaAcoesPedidas["pular"] = player.respostaAcoesPedidas["pular"] === undefined ? pular : player.respostaAcoesPedidas["pular"];
      }      
    }
    if(key == "cima" && (player.pilhaDeComandos["direcoes"]["cima"] == 0 ) ){
      //player.respostaAcoesPedidas["pular"] !== undefined ? delete player.respostaAcoesPedidas["pular"] : 0;      
    }

    if(key == "a" && (player.pilhaDeComandos["direcoes"]["a"] == 1 ) ){
      player.respostaAcoesPedidas["impulse"] = player.respostaAcoesPedidas["impulse"] === undefined ? impulse : player.respostaAcoesPedidas["impulse"];      
    }
    if(key == "a" && (player.pilhaDeComandos["direcoes"]["a"] == 0 ) ){
      player.respostaAcoesPedidas["impulse"] = player.respostaAcoesPedidas["impulse"] === undefined ? impulse : player.respostaAcoesPedidas["impulse"];      
    }

  }
  //if(player.pilhaDeComandos.length > 0){
    //var lastCommand = player.pilhaDeComandos[player.pilhaDeComandos.length - 1];
    //player.pilhaDeComandos = player.pilhaDeComandos.slice(0, -1);

    // if(player.pilhaDeComandos["dir"]){
    //   player.respostaAcoesPedidas["tryMoveDir"] = player.respostaAcoesPedidas["tryMoveDir"] === undefined ? tryMoveDir : player.respostaAcoesPedidas["tryMoveDir"]; 
    // }

    // if(lastCommand.acao == "tryStopMoveEsq" ){
    //   player.respostaAcoesPedidas["tryMoveEsq"] === undefined ? 0 : delete player.respostaAcoesPedidas["tryMoveEsq"]; 
    // }
    
    // if(lastCommand.acao == "tryMoveDir" ){
    //   player.respostaAcoesPedidas["tryMoveDir"] = player.respostaAcoesPedidas["tryMoveDir"] === undefined ? tryMoveDir : player.respostaAcoesPedidas["tryMoveDir"]; 
    // }

    // if(lastCommand.acao == "tryMoveDir" && previous.acao == "tryMoveDir" ){
    //   player.respostaAcoesPedidas["tryMoveDir"] = player.respostaAcoesPedidas["tryMoveDir"] === undefined ? tryAvancoDir : tryAvancoDir; 
    // }

    // if(lastCommand.acao == "tryStopMoveDir" ){
    //   player.respostaAcoesPedidas["tryMoveDir"] === undefined ? 0 : delete player.respostaAcoesPedidas["tryMoveDir"]; 
    // }

    // if(lastCommand.acao == "tryMoveBaixo" ){
    //   player.respostaAcoesPedidas["tryMoveBaixo"] = player.respostaAcoesPedidas["tryMoveBaixo"] === undefined ? tryMoveBaixo : player.respostaAcoesPedidas["tryMoveBaixo"]; 
    // }

    // if(lastCommand.acao == "tryStopMoveBaixo" ){
    //   player.respostaAcoesPedidas["tryMoveBaixo"] === undefined ? 0 : delete player.respostaAcoesPedidas["tryMoveBaixo"]; 
    // }
    
    // if(lastCommand.acao == "pular" ){
    //   player.respostaAcoesPedidas["pular"] = player.respostaAcoesPedidas["pular"] === undefined ? pular : player.respostaAcoesPedidas["pular"];
    // }

    //previous.acao = lastCommand.acao;
    //previous.frame = lastCommand.frame; 
  //}
}

function movimentacaoLogica(player){

  //Aplica os vetores direcao
  // player.moveDireita  == 1 ? tryMove(player, "x", 1, distPadrao)  : true ;
  // player.moveEsquerda == 1 ? tryMove(player, "x", -1, distPadrao) : true ;
  // player.moveCima     == 1 ? tryMove(player, "y", -1, distPadrao) : true ;
  // player.moveBaixo    == 1 ? tryMove(player, "y", 1, distPadrao)  : true ;
  
  for(var acao in player.respostaAcoesPedidas){
    player.respostaAcoesPedidas[acao](player);
  }
  
  // if(player.bounced.length > 0){
  //   player.bounced.forEach( function(elemento, index, arrayBounced) {
  //     if(elemento.iteracoes > 0 ){
  //       elemento.iteracoes--;
  //       tryMove(player, elemento.axis, elemento.direction, elemento.intensidade);
  //       elemento.iteracoes <= 0 ? arrayBounced.splice(index, 1) : 1;
  //     }
  //   });
  // }
}

function tryMoveEsq(player){
  var valor = tryMove(player, "x", -1, distPadrao);
  //delete player.respostaAcoesPedidas["tryMoveEsq"]
  return valor;
}

function tryAvancoEsq(player){
  var valor = tryMove(player, "x", -1, avancoPadrao);
  return valor;
}

function tryMoveDir(player){
  var valor = tryMove(player, "x", 1, distPadrao);
  //delete player.respostaAcoesPedidas["tryMoveDir"]
  return valor;
}

function tryAvancoDir(player){
  var valor = tryMove(player, "x", 1, avancoPadrao);
  return valor;
}

function tryMoveCima(player){
  var valor = tryMove(player, "y", -1, distPadrao);
  //delete player.respostaAcoesPedidas["tryMoveCima"]
  return valor;
}

function tryMoveBaixo(player){
  var valor = tryMove(player, "y", 1, distPadrao);
  //delete player.respostaAcoesPedidas["tryMoveBaixo"]
  return valor;
}

function tryMove(player, f, u1, u2){

  var projecaoPlayer = new Player(player);
  var resultadoColisao;
    
  moveXY(projecaoPlayer, u1, u2, f);
  resultadoColisao = colisaoComAlgumElementoMapa(projecaoPlayer, elementosMapa.filter(obj => projecaoPlayer.idObj != obj.idObj ));

  if(!resultadoColisao){
    moveXY(player, u1, u2, f);
  }else{
    if(resultadoColisao.bounce !== undefined ) {
      if(bounceCorrespond(resultadoColisao.bounce.directions, u1, f)){
        player.bounced.push(new Bounced({intensidade: resultadoColisao.bounce.intensidade, iteracoes: resultadoColisao.bounce.iteracoes, axis: f, direction: (-u1)}));
      }
    }  
    return 0;
  }
  
  return 1;
}

function bounceCorrespond(directions, u1, f){

  var polaridade;
  if( (u1 < 0) && ( f == "x") ){ polaridade = "right"}
  if( (u1 > 0) && ( f == "x") ){ polaridade = "left"}
  if( (u1 > 0) && ( f == "y") ){ polaridade = "up"}
  if( (u1 < 0) && ( f == "y") ){ polaridade = "down"} 

  for(var i = 0; i < directions.length; i++){

    if(directions[i] == polaridade ){
      return polaridade;
    }
  }

}

function moveXY(elemento, d, intensidade, f){
  f == "x" ? moveX(elemento, d, intensidade) : 1 ;
  f == "y" ? moveY(elemento, d, intensidade) : 1 ;
}

function moveX(elemento, d, intensidade){
  elemento.x = elemento.x + d * (intensidade ? intensidade : 1);
}

function moveY(elemento, d, intensidade){
  elemento.y = elemento.y + d * (intensidade ? intensidade : 1);
}


//tive q usar logica complicada pois Ã© complicado ser atrapalhado toda hora
function colisao2dCirculo( bolaA, bolaB ){ 
  
  var result = dist(bolaA.getCenter(), bolaB.getCenter()) <= (bolaA.getRaio() + bolaB.getRaio())
  console.log(dist(bolaA.getCenter(), bolaB.getCenter()));
  console.log(bolaA.getCenter() + " " + bolaB.getCenter())
  return result;
}

function colisao2dQuadratica( quadradoA, quadradoB){

  if( !inRange(quadradoA, quadradoB )){
    return 0;
  }else{
    return 1;
  }
}

function inRange( a , b){

  if( ( (a.x + a.width < b.x ) ) || ((a.x > b.x + b.width)) ){
    return 0;
  }else{
    if(( (a.y + a.height < b.y ) ) || ((a.y > b.y + b.height))){
      return 0;
    }
  }

  return 1;
}

// function aplicaBounce(quadradoA, quadradoB){

//   if(quadradoB.bounce !== undefined){
//       if(quadradoA.bounced === undefined){
//         quadradoA.bounced = [new Bounced(quadradoB.bounce)];
//       }else{
//         quadraoA.bounced = [...quadradoA.bounced, (new Bounced(quadradoB.bounce))];
//       }
//   }
// }


function colisaoComAlgumElementoMapa(projecaoPlayer, elementos){

  // for(var i = 0; i < elementos.length; i++){
  //   if(colisao2dCirculo(projecaoPlayer.getCirculo(), elementos[i].getCirculo())){
  //     return 1;
  //   }
  // }

  for(var i = 0; i < elementos.length; i++){
    if(colisao2dQuadratica(projecaoPlayer, elementos[i])){      
      return elementos[i];
    }
  }

  // for(var i = 0; i < grounds.length; i++){
  //   if(colisaoComGroundable(projecaoPlayer, grounds[i])){
  //     return grounds[i];
  //   }
  // }

  // var colide = colisaoComGroundable(projecaoPlayer, grounds);
  // if(colide){
  //   return colide;
  // }


  return 0;
}

// function colisaoComGround(player, grounds){

//   for(var i = 0; i < grounds.length; i++ ){
//     if( (player.y + player.height ) > grounds[i].y ){
//       return 1;
//     }
//   } 

//   return 0;
// }

function colisaoComGroundable(player, ground){
    
  if(colisao2dQuadratica(player, ground)){
    return 1;
  }

  return 0;
}

function isOnGround(player, grounds){

    var projecaoPlayer = new Player(player);
    moveXY(projecaoPlayer, 1, distPadrao, "y");

    for(var i = 0; i < grounds.length; i++){
      if(colisaoComGroundable(projecaoPlayer, grounds[i])){
        return grounds[i];
      }
    }
}

function dist(pontoA, pontoB){

  return Math.pow( ((pontoA.x - pontoB.x)**2 + (pontoA.y - pontoB.y)**2), 0.5 );
}

function aplicaGravidade(gravidadePadrao){

  var gravitaveis = elementosMapa.filter( obj => obj.gravitavel == 1 );
  gravitaveis.forEach( elemento => {tryMove(elemento, "y", 1, gravidadePadrao)} )
  //tryMove(player, "y", 1, 1);
}

function makeBounceable(obj, intensidade){

  if(obj.bounce === undefined){
    obj.bounce = new Bounce(intensidade);
  }
}

// function acaoPular(player){

//   if( player.pulo !== undefined ) {
//     player.pula = 0;
//     player.pulo.performa(player);
//   }else{
//     if(isOnGround(player, elementosMapa.filter(obj => obj.groundable == 1 && obj.idObj != player.idObj)) && player.pula == 1 ){
//       player.pula = 0;
//       player.pulo = new Pulo({size: 4, cima: 15, baixo: 0});
//       player.pulo.performa(player);
//     }
//   }
// }

function comandosLogicosNPC(jogavel){

  // if(jogavel.respostaAcoesPedidas["pular"] === undefined){
  //   jogavel.respostaAcoesPedidas["pular"]
  // }
  jogavel.nroPulos >= 5 ? 1 : pular(jogavel);
  
  jogavel.nroPulos >= 5 ? delete jogavel.respostaAcoesPedidas["tryMoveDir"] : jogavel.respostaAcoesPedidas["tryMoveDir"] = tryMoveDir;

  //pular(jogavel); 
  // jogavel.nroPulos = jogavel.nroPulos !== undefined ? jogavel.nroPulos + 1 : 0;
  // jogavel.pula = jogavel.nroPulos >= 3 ? 0 : 1;
}

//#endregion


//#region Event Listenners e Notificacoes
  document.addEventListener("keydown", function(event) {notifica(event);});
  document.addEventListener("keyup", function(event)   {notifica(event);});
  window.addEventListener('load', init);

  function notifica(e){

    if(e.type == "keydown"){ setaVetoresDirecao(player, e)}
    if(e.type == "keyup")  { setaVetoresDirecao(player, e)}

  }
//#endregion


//#region Desenho
  function desenhaQuadrado(obj){

    ctx.fillStyle = "#aaaaaa";
    ctx.fillRect(obj.x, obj.y, obj.width, obj.height);
  }

  function desenha(obj){

    ctx.fillStyle = "#aaaaaa";
    ctx.fillRect( obj.x, obj.y, obj.width, obj.height);
  }

  function limpaTela(){

    ctx.clearRect(0, 0, canvasWidth, canvasHeight);
  }

  function draw() {

    //comandosLogicosPlayer nao tem ainda por ser td teclado
    comandosLogicosNPC(npc1);

    gerenciadorComandos(player);
    gerenciadorComandos(npc1);

    movimentacaoLogica(player);
    movimentacaoLogica(npc1);

    aplicaGravidade(gravidadePadrao);
    aplicaGravidade(0.7*gravidadePadrao);
    //aplicaGravidade(0.75*gravidadePadrao);
    
    limpaTela(); 
    desenha(player);
    //desenha(grounds[0]);
    elementosMapa.forEach((elemento) => desenha(elemento));

    window.requestAnimationFrame(draw);
  }
//#endregion


//#region Math

function raio(ladoA, ladoB){ 
  return Math.pow( ((ladoA)**2 + (ladoB)**2), 0.5 ) 
}

function distancia(A, B){

  return Math.pow( ((A.x - B.x)**2 + (A.y - B.y)**2), 0.5 )
}

//#endregion


</script>

<script>
    
    //facilitar o desenvolvimento, parece q se o codigo for bom deve ficar facil colocar melhorias
    //  e continuar
    //acao de knoback, soco e raduquen flash, idem em npc, logica de dano
    //leitura da pilha com frame time
    //flush no vetor de sequencia de comandos
    //todos os valores abixo de height precisam ser revisados
    //colocar td no js
    //1 raÃ§a, 3 acoes, 1 expedicao com 1 mapa com 1 tela, 1 rancho fazenda, 1 comercio, 1 coliseu  
    //nao vai ter desempenho maximo nem rodar em td por hora
    //ok -ver classes pra ja colocar
    //colocar contexto de posicionamento e colisao
    //contexto de bitmap
    //alguma animacao de ataque
    //se conseguir duas animacoes de atq versionar
    //rn - precisa tirar nota em provas escrita e pratia pra ir ranked
    //talvez o raio medio entre o raio externo e o interno
    //bug com tres teclas

    //ok - movimentacao simples, colocar pra Y e adequar classes, colisao simples
    //ok - colocar alguns objs e possivelmente uma classe

   
    //nao funciona pois os valores estao no atributo inves do style
    //canvasHeight = document.getElementById("canvas").style.height;
    //canvasWidth = document.getElementById("canvas").style.width;

    //#region Logica de Codigo
    //Logica de Teclas
    ///Uma tecla qndo apertado Ã© registrada na secao event listener, depois o notificador usa
    //a funcao adequada dependendo do tipo de evento na secao movimentacao logica
    //nisso apenas a direcao e setado, ficando a cargo do loop iterar a movimentacao toda vez 
    //por ultimo o desenho apenas pega os dados e desenha
    //#endregion


</script>

<body style="height: 100%; overflow: hidden;">

    <div style="text-align: center">
        <canvas id="canvas" width="350" height="100" 
          style="border: 1px solid #c9c9c9;">
        </canvas>
    </div>
    
</body>
</html>



